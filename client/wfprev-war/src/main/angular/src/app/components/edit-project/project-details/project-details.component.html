<wfprev-timestamp
  [updateDate]="projectDetail?.lastUpdatedTimestamp"
  [updateUser]="projectDetail?.updateUser">
</wfprev-timestamp>
<div class="details-container">
  <form [formGroup]="detailsForm" class="form-grid" *ngIf="projectDetail">
    <div class="form-item">
      <wfprev-input-field
        [id]="'projectname'"
        [label]="'Project Name'"
        [required]="true"
        [placeholder]="'Concisely describe project\'s goal and/or area'"
        [control]="getControl('projectName')"
        [tooltip]="getControl('projectName').value"
        [errorMessages]="{ maxlength: messages.maxLengthExceeded }"
      ></wfprev-input-field>
    </div>

    <div class="form-item">
      <wfprev-select-field
        [label]="'Project Type'"
        [required]="true"
        [control]="getControl('projectTypeCode')"
        [options]="projectTypeCode"
        [optionValueField]="'projectTypeCode'"
        [optionLabelField]="'description'"
        [tooltip]="projectTypeLocked 
          ? messages.projectTypeCannotUpdateAfterEndorsed
          : getCodeDescription(CodeTableKeys.PROJECT_TYPE_CODE)"
        [disabled]="projectTypeLocked"
        id="projectTypeCode"
        placeholder="Select"
      />
    </div>

    <div class="form-item funding-stream">
      <label>Funding Stream</label>
      <input type="text" readonly />
    </div>

    <div class="form-item">
      <wfprev-input-field
        [id]="'resultsProjectCode'"
        [label]="'RESULTS Project Code'"
        [placeholder]="'e.g., WRSE0180'"
        [control]="getControl('resultsProjectCode')"
        [tooltip]="'WRR project numbers generated by BCWS'"
        [errorMessages]="{ maxlength: messages.maxLengthExceeded }"
      ></wfprev-input-field>
    </div>

    <div class="form-item">
      <wfprev-select-field
        [label]="'Business/Program Area'"
        [required]="true"
        [control]="getControl('programAreaGuid')"
        [options]="programAreaCode"
        [optionValueField]="'programAreaGuid'"
        [optionLabelField]="'programAreaName'"
        [tooltip]="getCodeDescription(CodeTableKeys.PROGRAM_AREA_GUID)"
        id="programAreaGuid"
      />
    </div>

    <div class="form-item">
      <wfprev-select-field
        [label]="'Forest Region'"
        [required]="true"
        [control]="getControl('forestRegionOrgUnitId')"
        [options]="forestRegionCode"
        [optionValueField]="'orgUnitId'"
        [optionLabelField]="'orgUnitName'"
        [tooltip]="getCodeDescription(CodeTableKeys.FOREST_REGION_ORG_UNIT_ID)"
        id="forestRegionOrgUnitId"
      />
    </div>

    <div class="form-item">
      <wfprev-select-field
        [label]="'Forest District'"
        [required]="false"
        [control]="getControl('forestDistrictOrgUnitId')"
        [options]="forestDistrictCode"
        [optionValueField]="'orgUnitId'"
        [optionLabelField]="'orgUnitName'"
        [tooltip]="getCodeDescription(CodeTableKeys.FOREST_DISTRICT_ORG_UNIT_ID)"
        [placeholder]="'Select'"
        id="forestDistrictOrgUnitId"
      />
    </div>

    <div class="form-item">
      <wfprev-select-field
        [label]="'BC Parks Region'"
        [required]="false"
        [control]="getControl('bcParksRegionOrgUnitId')"
        [options]="bcParksRegionCode"
        [optionValueField]="'orgUnitId'"
        [optionLabelField]="'orgUnitName'"
        [tooltip]="getCodeDescription(CodeTableKeys.BC_PARKS_REGION_ORG_UNIT_ID)"
        [placeholder]="'Select'"
        id="bcParksRegionOrgUnitId"
      />
    </div>

    <div class="form-item">
      <wfprev-select-field
        [label]="'BC Parks Section'"
        [required]="false"
        [control]="getControl('bcParksSectionOrgUnitId')"
        [options]="bcParksSectionCode"
        [optionValueField]="'orgUnitId'"
        [optionLabelField]="'orgUnitName'"
        [tooltip]="getCodeDescription(CodeTableKeys.BC_PARKS_SECTION_ORG_UNIT_ID)"
        [placeholder]="'Select'"
        id="bcParksSectionOrgUnitId"
      />
    </div>

    <div class="form-item">
      <wfprev-select-field
        [label]="'BCWS Fire Centre'"
        [required]="true"
        [control]="getControl('wildfireOrgUnitId')"
        [options]="fireCentres"
        [optionValueField]="'orgUnitIdentifier'"
        [optionLabelField]="'orgUnitName'"
        [tooltip]="getCodeDescription(CodeTableKeys.WILDFIRE_ORG_UNIT_ID)"
        id="wildfireOrgUnitId"
      />
    </div>

    <div class="form-item">
      <wfprev-input-field
        [id]="'projectLead'"
        [label]="'Project Lead'"
        [placeholder]="'First and Last Name'"
        [control]="getControl('projectLead')"
        [tooltip]="getControl('projectLead').value"
        [required]="true"
        [errorMessages]="{ maxlength: messages.maxLengthExceeded }"
      />
    </div>

    <div class="form-item">
      <wfprev-input-field
        [id]="'projectLeadEmailAddress'"
        [label]="'Project Lead Email'"
        [placeholder]="'example@bc.gov.ca'"
        [control]="getControl('projectLeadEmailAddress')"
        [tooltip]="getControl('projectLeadEmailAddress').value"
        [type]="'email'"
        [errorMessages]="{
          email: messages.invalidEmail,
          maxlength: messages.maxLengthExceeded
        }"
      />
    </div>

    <div class="form-item">
      <wfprev-input-field
        [id]="'closestCommunityName'"
        [label]="'Closest Community'"
        [placeholder]="'Name of closest community to the project'"
        [control]="getControl('closestCommunityName')"
        [tooltip]="getControl('closestCommunityName').value"
        [required]="true"
        [errorMessages]="{ maxlength: messages.maxLengthExceeded }"
      ></wfprev-input-field>
    </div>

    <div class="form-item">
      <wfprev-input-field
        [id]="'siteUnitName'"
        [label]="'Planning Unit'"
        [placeholder]="'e.g., 2025WUI-WRR- Nelson to Playmor- NE-C1-01'"
        [control]="getControl('siteUnitName')"
        [tooltip]="getControl('siteUnitName').value"
        [errorMessages]="{ maxlength: messages.maxLengthExceeded }"
      />
    </div>

    <div class="form-item">
      <wfprev-select-field
        [label]="'Primary Objective'"
        [required]="true"
        [control]="getControl('primaryObjectiveTypeCode')"
        [options]="objectiveTypeCode"
        [optionValueField]="'objectiveTypeCode'"
        [optionLabelField]="'description'"
        [tooltip]="getCodeDescription(CodeTableKeys.PRIMARY_OBJECTIVE_TYPE_CODE)"
        id="primaryObjectiveTypeCode"
      />
    </div>

    <div class="form-item">
      <wfprev-select-field
        [label]="'Secondary Objective'"
        [required]="false"
        [control]="getControl('secondaryObjectiveTypeCode')"
        [options]="objectiveTypeCode"
        [optionValueField]="'objectiveTypeCode'"
        [optionLabelField]="'description'"
        [tooltip]="getCodeDescription(CodeTableKeys.SECONDARY_OBJECTIVE_TYPE_CODE)"
        id="secondaryObjectiveTypeCode"
        [placeholder]="'Select'"
      />
    </div>

    <div class="form-item secondary-rationale">
      <wfprev-textarea
        label="Secondary Objective Rationale"
        inputId="secondaryObjectiveRationale"
        placeholder="Describe any additional objectives beyond wildfire risk reduction."
        [control]="secondaryObjectiveRationaleCtrl"
        [maxLength]="500"
        [rows]="2">
      </wfprev-textarea>
    </div>

    <div class="footer">
      <div class="button-row">
        <button class="secondary" (click)="onCancel()" [disabled]="!detailsForm.dirty">Cancel</button>
        <button type="button" (click)="onSave()" [disabled]="!detailsForm.valid || !detailsForm.dirty"
          class="primary">Save
        </button>
      </div>
    </div>
  </form>
</div>
<div class="description-map-section">
  <div class="project-left-section">
    <mat-expansion-panel #panel="matExpansionPanel">
      <mat-expansion-panel-header class="expansion-panel-header">
        <mat-panel-title class="project-title">
          <wfprev-expansion-indicator [isExpanded]="panel.expanded"></wfprev-expansion-indicator>
          <span>Project Description</span>
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div class="project-form">
        <form class="project-description">
          <textarea
            [(ngModel)]="projectDescription"
            name="projectDescription"
            rows="1"
            class="editable-description"
            cdkTextareaAutosize 
            [cdkAutosizeMinRows]="1"
            [cdkAutosizeMaxRows]="50"
            [attr.maxlength]="PROJECT_DESC_MAX"
            #autosize="cdkTextareaAutosize"
            placeholder="Describe the project purpose, location, and key activities involved in wildfire risk reduction."
            (ngModelChange)="onProjectDescriptionChange($event)"
            (input)="onProjectInput($event)"
            (paste)="onProjectPaste($event)"
            [ngClass]="{ 'over-limit': (projectDescription?.length ?? 0) >= 4000 }"
          ></textarea>

          <div class="feedback-row">
            <div class="error" [class.invisible]="!((projectDescription?.length ?? 0) >= 4000)">
              {{ messages.maxLengthExceeded }}
            </div>
            <div class="counter" [ngClass]="{ 'over': (projectDescription?.length ?? 0) >= 4000 }">
              {{ projectDescription?.length || 0 }} / 4000
            </div>
          </div>

          <div class="project-description-footer">
            <div class="button-row">
              <button class="secondary" (click)="onCancelProjectDescription()"
                [disabled]="!isProjectDescriptionDirty">Cancel</button>
              <button class="primary" [disabled]="!isProjectDescriptionDirty || ((projectDescription?.length ?? 0) > 4000)" (click)="onSaveProjectDescription()">
                Save
              </button>
            </div>
          </div>
        </form>
      </div>


    </mat-expansion-panel>
    <wfprev-fiscal-year-projects></wfprev-fiscal-year-projects>
    <wfprev-evaluation-criteria [project]="projectDetail"></wfprev-evaluation-criteria>
  </div>

  <div class="map-section">
    <div id="map"></div>
    <div class="latlong-section">
      <form>
        <label for="coordinates">Latitude/Longitude:</label>
        <div class="input-group">
          <input type="text" id="coordinates" [(ngModel)]="latLong" name="latLong"
            placeholder="e.g., 50.5343° N, -120.6408° W"
            (ngModelChange)="onLatLongChange($event)" />
          <button type="button" (click)="onSaveLatLong()" [disabled]="!isLatLongDirty" class="primary">Save
          </button>
        </div>
      </form>
    </div>
    <wfprev-project-files (filesUpdated)="onFilesUpdated()" [projectGuid]="projectGuid"></wfprev-project-files>
  </div>
</div>
